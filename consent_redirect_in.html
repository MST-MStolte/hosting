<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Redirecting to Consent Form...</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            margin: 0;
            background-color: #f0f0f0;
        }
        .container {
            text-align: center;
            background: white;
            padding: 40px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .error {
            color: #e74c3c;
            margin-top: 20px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h2>Redirecting to Consent Form</h2>
        <div class="spinner"></div>
        <p>Please wait while we prepare the consent form...</p>
        <p id="status"></p>
        <div id="error" class="error" style="display: none;"></div>
    </div>

    <script>
        // Sway consent form URL
        const SWAY_URL = 'https://sway.cloud.microsoft/oB7L0QAAuYssqeNh?ref=Link&loc=play';

        // Capture URL parameters from UvA Lab Tool
        function getUrlParams() {
            const params = {};
            const searchParams = new URLSearchParams(window.location.search);

            for (const [key, value] of searchParams.entries()) {
                params[key] = value;
            }

            return params;
        }

        // Store parameters in sessionStorage (survives across pages in same tab/window)
        function storeLabToolParams() {
            try {
                const params = getUrlParams();

                // Check if we have the required parameters
                if (!params.tid || !params.access_key) {
                    document.getElementById('status').textContent =
                        'Warning: Lab tool parameters (tid/access_key) not found. ' +
                        'You may not receive credit for this participation.';
                    console.warn('Missing tid or access_key parameters', params);
                }

                // Store all parameters for later retrieval
                sessionStorage.setItem('labToolParams', JSON.stringify(params));

                // Store timestamp to detect if session is too old
                sessionStorage.setItem('labToolParamsTime', Date.now().toString());

                console.log('Stored lab tool parameters:', params);

                return true;
            } catch (error) {
                console.error('Error storing parameters:', error);
                document.getElementById('error').style.display = 'block';
                document.getElementById('error').textContent =
                    'Error: Could not store session data. Please enable cookies and try again.';
                return false;
            }
        }

        // Redirect to Sway after storing parameters
        function redirectToConsent() {
            const params = getUrlParams();

            // Check if we have lab tool parameters
            const hasLabToolParams = params.tid && params.access_key;

            if (!hasLabToolParams) {
                // CASE 1: Direct access without lab tool parameters
                // This happens when someone shares/bookmarks the link
                document.getElementById('status').innerHTML =
                    '<strong>Note:</strong> You are accessing this study directly.<br>' +
                    'You will NOT receive course credits for this participation.<br>' +
                    'Continuing to consent form...';

                console.log('Direct access detected - no lab tool parameters');

                // Store a flag to indicate no credits
                sessionStorage.setItem('directAccess', 'true');
                sessionStorage.removeItem('labToolParams'); // Make sure no old params exist
            } else {
                // Normal flow with lab tool parameters
                document.getElementById('status').textContent = 'Redirecting to consent form...';
            }

            if (storeLabToolParams()) {
                // Small delay to ensure storage completes
                setTimeout(() => {
                    window.location.href = SWAY_URL;
                }, hasLabToolParams ? 500 : 2000); // Longer delay to show warning
            }
        }

        // Execute on page load
        redirectToConsent();
    </script>
</body>
</html>
